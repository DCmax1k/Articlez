<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= data.user.firstname %>'s Articles</title>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.13.0/css/all.css"
      integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/assets/main.css" />
    <link rel="stylesheet" href="/assets/home.css" />
    <link rel="stylesheet" href="/assets/myarticles.css" />
  </head>
  <body>
    <div id="background">
      <img src="/images/index.svg" alt="Background" />
    </div>
    <form
      action="/home/myarticles/<%= data.user.username %>?k=<%= data.user._id %>"
      method="POST"
      id="newArticleForm"
    >
      <i id="closeForm" class="far fa-times-circle"></i>
      <div>
        <label id="titleLabel" class="light" for="title">Title</label>
        <input
          type="text"
          id="titleInput"
          name="title"
          class="light-background"
          required
        />
        <p id="characterLimit">50 Characters Left</p>
      </div>
      <div>
        <label class="light" for="title"
          >Text
          <span id="characterLimitText"> - 5000 Characters Left</span></label
        >
        <textarea
          name="text"
          id="text"
          cols="30"
          rows="10"
          class="light-background"
          required
        ></textarea>
      </div>
      <button type="submit" class="orange-background dark">Publish</button>
    </form>
    <header class="dark-light-background">
      <div id="logo">
        <h1 style="transform: translateY(-5%);">
          <a
            class="light"
            href="/home/<%= data.user.username %>?k=<%= data.user._id %>"
            >Articlez</a
          >
        </h1>
      </div>
      <ul style="width: 450px;">
        <li>
          <a
            class="light"
            href="/home/<%= data.user.username %>?k=<%= data.user._id %>"
            >Home</a
          >
        </li>
        <li>
          <a
            style="border-top: 2px solid white; border-bottom: 2px solid white;"
            class="light"
            href="/home/myarticles/<%= data.user.username %>?k=<%= data.user._id %>"
            >My Articles</a
          >
        </li>
        <li id="logoutBtn" class="orange">Log out</li>
      </ul>
    </header>
    <div class="body-cont">
      <div id="title" class="row">
        <h2>My Articles <span>&nbsp; - all personal articles</span></h2>
        <p id="openForm">
          <i class="fas fa-plus"></i>&nbsp; Publish New Article
        </p>
      </div>

      <!-- Start of articles -->
      <% if (data.articles.length === 0) { %>
      <div class="no-articles">
        <h1>
          <i class="fas fa-info-circle"></i>&nbsp; You have not published any
          articles
        </h1>
      </div>
      <% } %> <% data.articles.reverse().forEach((article, i) => { %>
      <div id="article<%= i %>" class="article">
        <i id="trash<%= article._id %>" class="fas fa-trash-alt trash-icon"></i>
        <div class="blur">
          <p id="readMoreBtn<%= i %>" class="read-more">Read More</p>
        </div>
        <div class="article-heading">
          <h1><%= article.title %></h1>
          <h4><%= article.date.toLocaleDateString() %></h4>
        </div>
        <hr />
        <p class="article-text">
          <%= JSON.stringify( article.text ) %>
        </p>
        <div class="author">
          <p>
            by <%= article.author.firstname %> <%= article.author.lastname %> -
            @<%= article.author.username %> <% if (article.author.rank ===
            'owner') {%> &nbsp; <i class="fas fa-key orange"></i> <% } else if
            (article.author.rank === 'admin') { %> &nbsp;
            <i class="fas fa-certificate dark-light"></i> <% } %>
          </p>
        </div>
      </div>
      <% }) %>
      <!-- End of Articles -->
    </div>
    <!-- Start of hidden forms -->
    <form
      action="/logout?k=<%= data.user._id %>"
      method="POST"
      id="logoutForm"
      class="display-none"
    ></form>
    <form
      method="POST"
      action="/home/deletearticlehome?k=<%= data.user._id %>&from=myarticles"
      id="deleteArticleForm"
      class="display-none"
    >
      <input name="articleId" id="articleIdInput" type="text" />
    </form>
    <!-- Script Section -->
    <script>
      // Logout - here and home
      const logoutBtn = document.getElementById('logoutBtn');
      const logoutForm = document.getElementById('logoutForm');
      logoutBtn.addEventListener('click', () => {
        logoutForm.submit();
      });
      const openForm = document.getElementById('openForm');
      const closeForm = document.getElementById('closeForm');
      const articleForm = document.getElementById('newArticleForm');
      const title = document.getElementById('titleInput');
      const text = document.getElementById('text');
      const characterLimit = document.getElementById('characterLimit');
      const characterLimitText = document.getElementById('characterLimitText');

      title.addEventListener('input', () => {
        if (title.value.length > 50) {
          title.value = title.value.slice(0, 50);
        }
        characterLimit.innerText = `${50 - title.value.length} Characters Left`;
      });
      text.addEventListener('input', () => {
        if (text.value.length > 5000) {
          text.value = text.value.slice(0, 5000);
        }
        characterLimitText.innerText = `- ${
          5000 - text.value.length
        } Characters Left`;
      });
      openForm.addEventListener('click', () => {
        articleForm.style.visibility = 'visible';
      });
      closeForm.addEventListener('click', () => {
        articleForm.style.visibility = 'hidden';
      });

      // Loops through all articles - All pages
      const articles = document.querySelectorAll('.article');
      articles.forEach((article, i) => {
        if (article.offsetHeight > 500) {
          article.classList.add('shortenArticle');
        }
      });
      const readMoreBtns = document.querySelectorAll('.read-more');
      readMoreBtns.forEach((btn) => {
        let id = btn.id.slice(btn.id.length - 1);
        btn.addEventListener('click', () => {
          document
            .getElementById(`article${id}`)
            .classList.remove('shortenArticle');
        });
      });
      const deleteArticleForm = document.getElementById('deleteArticleForm');
      const articleIdInput = document.getElementById('articleIdInput');
      const trashIcons = document.querySelectorAll('.trash-icon');
      trashIcons.forEach((icon) => {
        let id = icon.id.slice(5);
        icon.addEventListener('click', () => {
          articleIdInput.value = id;
          deleteArticleForm.submit();
        });
      });
      const articleText = document.querySelectorAll('.article-text');
      articleText.forEach((text) => {
        let newTextArr = text.innerHTML
          .replace(/\\r\\n/gi, '<br />')
          .trim()
          .split('');
        newTextArr.pop();
        newTextArr.shift();
        newText = newTextArr.join('');
        text.innerHTML = newText;
      });
    </script>
  </body>
</html>
